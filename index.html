<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>H·ªçc Ngo·∫°i Ng·ªØ AI</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap');
  :root{
    --bg-sky:#a7e0ff; --bg-grass:#b4f8c8; --primary:#fbe7c6; --secondary:#ffd6a5; --accent: #84a9ff;
    --danger:#ff8a80; --ok:#b9f6ca; --text:#3d2a1f; --panel:#ffffffee; --card-bg: #fff;
    --shadow-color: #00000020; --sidebar-bg: #fdfaf4; --disabled: #dcdcdc;
  }
  *{box-sizing:border-box;margin:0;padding:0; font-family:'Quicksand', sans-serif;}
  body{
    background:linear-gradient(135deg, var(--bg-sky), var(--bg-grass));
    color:var(--text); min-height:100vh;
    display:flex; overflow: hidden;
  }

  /* --- B·ªê C·ª§C CH√çNH --- */
  #sidebar{
    width: 280px; flex-shrink: 0; background: var(--sidebar-bg);
    padding: 1.5rem; display: flex; flex-direction: column;
    box-shadow: 4px 0 20px var(--shadow-color); z-index: 1001;
    transition: transform 0.3s ease-in-out;
  }
  #main-content{ flex: 1; position: relative; }
  
  #menu-toggle { display: none; }

  @media (max-width: 768px) {
    body { flex-direction: column; }
    #sidebar { 
        width: 100%; height: auto; position: fixed; top: 0; 
        transform: translateY(-120%); /* Start hidden further up */
        padding: 1rem;
        box-shadow: 0 4px 10px var(--shadow-color);
    }
    #sidebar.open { transform: translateY(0); }
    #main-content { padding-top: 0; }
    #menu-toggle {
      display: block; position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1002;
      background: var(--accent); color: white; border-radius: 50%; width: 60px; height: 60px;
      border: none; font-size: 1.8rem; box-shadow: 0 4px 15px var(--shadow-color);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .sidebar-header { display: none; }
    .sidebar-nav { flex-direction: row !important; gap: 0.5rem !important; justify-content: center; width: 100%; margin-top: 0;}
    .sidebar-hud { display: none !important; }
    .sidebar-nav .btn { font-size: 0.9rem; padding: 0.6em 0.8em;}
  }

  /* --- COMPONENTS --- */
  .sidebar-header { text-align: center; margin-bottom: 2rem;}
  .sidebar-hud { background: #ffffffaa; border-radius: 16px; padding: 1rem; margin-bottom: 1.5rem; }
  .hud-item { margin-bottom: 0.5rem; font-size: 1.1rem; font-weight: 700; }
  .sidebar-nav { margin-top: auto; display: flex; flex-direction: column; gap: 0.5rem; }
  .sidebar-hud, .game-controls { display: none; }
  .game-active .sidebar-hud, .game-active .game-controls { display: flex; flex-direction: column; }
  
  /* --- M√ÄN H√åNH (SCREEN) --- */
  .screen{
    position:absolute; inset:0; padding:clamp(1rem, 5vh, 2rem);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    transition: opacity .35s ease-in-out, transform .35s ease-in-out;
    gap:clamp(0.8rem, 2vh, 1.5rem); text-align:center;
    overflow-y: auto;
  }
  .hidden{ opacity:0; transform:scale(.97); pointer-events:none; }
  
  h1{font-size:clamp(32px, 8vw, 52px);}
  h2{font-size:clamp(24px, 6vw, 40px);}
  .btn{
    width: 100%; padding:.8em 1.5em; border:none; border-radius:12px;
    background:var(--primary); font-weight:700; cursor:pointer;
    box-shadow: 0 4px var(--shadow-color);
    margin:.3em 0; transition: all .1s ease-out;
    font-size: clamp(16px, 4vw, 20px);
  }
  .btn:hover:not([disabled]){ transform:translateY(-2px); box-shadow:0 6px 12px var(--shadow-color); }
  .btn:active:not([disabled]){ transform:translateY(1px); box-shadow:0 2px 4px var(--shadow-color); }
  .btn.accent { background-color: var(--accent); color: white; }
  .btn.danger { background-color: var(--danger); color: white; }
  .btn.ok { background-color: var(--ok); }
  .btn.small { padding: 0.6em 1em; font-size: clamp(14px, 3vw, 16px); }
  .btn[disabled]{opacity:.5; cursor:not-allowed; }
  input, textarea, select {
    width:min(520px, 90%); padding:.8em; font-size:1.05em; text-align:center;
    border:3px solid var(--secondary); border-radius:14px; background:var(--card-bg); margin-bottom: 1rem;
  }
  textarea { min-height: 120px; text-align: left; }

  /* --- C√†i ƒë·∫∑t & Sliders --- */
  .settings-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: center; width: 100%;}
  .setting-item { display: flex; flex-direction: column; gap: 0.5rem; }
  .setting-item label { font-weight: 700; }
  .setting-item input[type="range"] { width: 100%; }

  /* --- Set Selection & AI Generation --- */
  .content-wrapper { display: flex; flex-direction: column; gap: 2rem; width: 100%; max-width: 900px; }
  .set-container { background: var(--panel); padding: 1.5rem; border-radius: 16px; }
  #saved-sets-list { list-style: none; padding: 0; max-height: 40vh; overflow-y: auto; }
  #saved-sets-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-bottom: 1px solid #eee; }
  
  /* --- GAME SCREEN --- */
  #game-content { width:100%; height: 100%; display:flex; flex-direction: column; align-items:center; justify-content:center; gap:1.5rem; padding: 1rem; }
  .game-panel {
    background: var(--panel); border-radius: 24px; padding: clamp(1rem, 2vw, 2rem);
    box-shadow: 0 8px 25px var(--shadow-color); display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 1.5rem; width: 100%;
  }
  .question-panel { flex: 1; max-height: 50%; }
  .answer-panel { flex: 1; max-height: 50%; overflow-y: auto; }
  .question-panel img { max-width: 100%; max-height: 35vh; object-fit: contain; border-radius: 16px; }
  #listen-again-btn { font-size: 3em; background: none; border: none; cursor: pointer; }
  .choices-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:.8rem; width:100%; }
  
  /* --- FILL IN BLANK MODE --- */
  #word-slots{display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; margin-bottom: 1rem; }
  .slot{
    width:clamp(40px, 10vw, 55px); height:clamp(50px, 12vw, 65px); border:3px dashed #bcd; border-radius:10px;
    background:#f6fbff; display:flex; align-items:center; justify-content:center;
    font-size: clamp(1.5em, 5vw, 2em); font-weight:700;
  }
  .slot.filled{border-style:solid; background:var(--card-bg);}
  #letter-bank{display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; max-width: 100%;}
  .letter-tile{
    width:clamp(45px, 11vw, 60px); height:clamp(45px, 11vw, 60px); border-radius:12px; background:#ffe9a8;
    box-shadow: 0 4px #e1c06a; font-weight:700; cursor:pointer;
    display:flex; align-items:center; justify-content:center; font-size:clamp(1.2em, 4vw, 1.8em);
  }
  .letter-tile.hidden{ visibility:hidden; }

  /* --- MODALS --- */
  .modal-overlay{ background:#00000088; z-index: 1000; }
  .modal-box{ background:var(--card-bg); padding:1.5rem; border-radius:16px; width:min(500px, 90%); animation: pop-in .3s ease-out; }
  @keyframes pop-in { from { transform:scale(0.9); opacity:0; } to { transform:scale(1); opacity:1; } }
  .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--secondary); border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
</style>
</head>
<body>

<button id="menu-toggle">‚ò∞</button>
<div id="sidebar">
    <div class="sidebar-header"> <h2>H·ªçc AI</h2> </div>
    <div class="sidebar-hud">
        <div id="score-display" class="hud-item">üíØ ƒêi·ªÉm: 0</div>
        <div id="lives-display" class="hud-item">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>
    <nav class="sidebar-nav">
        <div class="game-controls"> <button id="home-btn" class="btn">üè† V·ªÅ Menu</button> </div>
        <button id="nav-learn-btn" class="btn accent">üìö H·ªçc T·ª´ V·ª±ng</button>
        <button id="nav-translate-btn" class="btn secondary">üåê D·ªãch Thu·∫≠t</button>
    </nav>
</div>

<main id="main-content">
  <!-- START -->
  <div id="start-screen" class="screen">
    <h1>H·ªçc Ngo·∫°i Ng·ªØ AI</h1>
    <p>Nh·∫≠p t√™n c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>
    <input id="player-name-input" maxlength="20" placeholder="T√™n c·ªßa b·∫°n ‚úèÔ∏è"/>
    <button id="start-btn" class="btn ok">B·∫Øt ƒë·∫ßu ‚ñ∂Ô∏è</button>
  </div>
  
  <!-- SET SELECTION -->
  <div id="set-selection-screen" class="screen hidden">
    <h2>Ch·ªçn ho·∫∑c t·∫°o ch·ªß ƒë·ªÅ ƒë·ªÉ h·ªçc</h2>
    <div class="content-wrapper">
        <div class="set-container">
            <h3>T·∫°o b·ªô t·ª´ v·ª±ng b·∫±ng AI ‚ú®</h3>
            <input id="ai-topic-input" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ (vd: v≈© tr·ª•, ngh·ªÅ nghi·ªáp...)"/>
            <div class="settings-group">
                <div class="setting-item">
                    <label>S·ªë l∆∞·ª£ng t·ª´: <span id="word-count-label">7</span></label>
                    <input type="range" id="word-count" min="3" max="15" value="7">
                </div>
                <div class="setting-item">
                    <label>S·ªë l∆∞·ª£ng c√¢u: <span id="sentence-count-label">4</span></label>
                    <input type="range" id="sentence-count" min="1" max="10" value="4">
                </div>
            </div>
            <button id="ai-generate-btn" class="btn accent">T·∫°o Ngay!</button>
        </div>
        <div class="set-container">
            <h3>B·ªô t·ª´ ƒë√£ l∆∞u & c√≥ s·∫µn</h3>
            <ul id="saved-sets-list"></ul>
        </div>
    </div>
  </div>

  <!-- TRANSLATE SCREEN -->
  <div id="translate-screen" class="screen hidden">
      <h2>C√¥ng c·ª• D·ªãch Thu·∫≠t AI üåê</h2>
      <div class="modal-box" style="width: min(600px, 95%)">
          <div class="settings-group" style="margin-bottom: 1rem;">
              <select id="translate-source-lang"></select>
              <select id="translate-target-lang"></select>
          </div>
          <textarea id="translate-input" placeholder="Nh·∫≠p vƒÉn b·∫£n c·∫ßn d·ªãch..."></textarea>
          <button id="translate-btn" class="btn ok">D·ªãch</button>
          <div id="translate-output" style="margin-top: 1rem; padding: 1rem; background: #f0f0f0; border-radius: 8px; min-height: 50px; text-align: left;"></div>
      </div>
  </div>

  <!-- LANGUAGE SELECTION -->
  <div id="lang-selection-screen" class="screen hidden">
      <h2>Ch·ªçn ng√¥n ng·ªØ ƒë·ªÉ h·ªçc</h2>
      <div class="modal-box">
          <div class="settings-group">
              <div class="setting-item"><label>H·ªçc t·ª´:</label><select id="source-lang-select"></select></div>
              <div class="setting-item"><label>Sang:</label><select id="target-lang-select"></select></div>
          </div>
          <button id="confirm-lang-btn" class="btn ok" style="margin-top: 1rem;">Ti·∫øp t·ª•c</button>
          <button id="lang-select-back-btn" class="btn">‚¨ÖÔ∏è ƒê·ªïi ch·ªß ƒë·ªÅ</button>
      </div>
  </div>

  <!-- PRACTICE TYPE SELECTION -->
  <div id="practice-type-screen" class="screen hidden">
      <h2 id="practice-set-title"></h2>
      <p>B·∫°n mu·ªën luy·ªán t·∫≠p g√¨?</p>
      <div style="width: min(400px, 90%)">
          <button class="btn ok" data-type="word">T·ª´ V·ª±ng</button>
          <button class="btn ok" data-type="sentence">M·∫´u C√¢u</button>
          <button class="btn" id="practice-type-back-btn">‚¨ÖÔ∏è ƒê·ªïi ng√¥n ng·ªØ</button>
      </div>
  </div>

  <!-- GAME SETUP SCREEN -->
  <div id="game-setup-screen" class="screen hidden">
      <h2>C√†i ƒë·∫∑t tr√≤ ch∆°i</h2>
      <div class="modal-box">
          <div class="setting-item">
              <label>S·ªë l∆∞·ª£ng c√¢u h·ªèi: <span id="question-count-label">10</span></label>
              <input type="range" id="question-count" min="5" max="20" value="10">
          </div>
          <button id="start-normal-game-btn" class="btn ok">B·∫Øt ƒë·∫ßu</button>
          <button id="start-review-game-btn" class="btn accent">√în t·∫≠p <span id="review-count">(0)</span> t·ª´ sai</button>
          <button id="game-setup-back-btn" class="btn">‚¨ÖÔ∏è Quay l·∫°i</button>
      </div>
  </div>

  <!-- MENU (Game Mode Selection) -->
  <div id="menu-screen" class="screen hidden">
    <h2 id="menu-title">Ch·ªçn ch·∫ø ƒë·ªô ch∆°i</h2>
    <div id="game-modes-grid" class="choices-grid"></div>
    <button id="menu-back-btn" class="btn">‚¨ÖÔ∏è Quay l·∫°i</button>
  </div>

  <!-- GAME -->
  <div id="game-screen" class="screen hidden">
    <!-- Game content will be dynamically generated -->
  </div>

  <!-- END -->
  <div id="end-screen" class="screen hidden">
    <h2>K·∫øt th√∫c!</h2>
    <p>ƒêi·ªÉm cu·ªëi c√πng c·ªßa b·∫°n:</p>
    <h1 id="final-score">0</h1>
    <button id="restart-btn" class="btn ok">Ch∆°i l·∫°i üîÑ</button>
    <button id="to-menu-btn" class="btn">üè† V·ªÅ Menu ch√≠nh</button>
  </div>

  <!-- MODALS -->
  <div id="loading-modal" class="screen hidden modal-overlay">
      <div class="loading-indicator">
          <div class="loader"></div>
          <p id="loading-text" style="color: white; margin-top: 1rem;">ƒêang t·∫£i...</p>
      </div>
  </div>
  <div id="save-set-modal" class="screen hidden modal-overlay">
      <div class="modal-box">
          <h2>L∆∞u b·ªô t·ª´ v·ª±ng?</h2>
          <p>B·∫°n c√≥ mu·ªën l∆∞u l·∫°i b·ªô t·ª´ "<b id="save-set-topic"></b>" ƒë·ªÉ h·ªçc l·∫°i sau kh√¥ng?</p>
          <div>
              <button id="confirm-save-btn" class="btn ok">L∆∞u l·∫°i</button>
              <button id="cancel-save-btn" class="btn secondary">Kh√¥ng, c·∫£m ∆°n</button>
          </div>
      </div>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { VOCABULARY_SETS as initialSets } from './vocabulary.js';

    // IMPORTANT: Replace this with your actual Firebase config from your project settings
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY", // Use Environment Variable
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    
    // Check for Netlify environment variables
    // In production, Netlify will inject these. For local dev, you'd use `netlify dev`.
    if (window.netlify) {
        firebaseConfig.apiKey = window.netlify.env.get('VITE_FIREBASE_API_KEY');
        firebaseConfig.authDomain = window.netlify.env.get('VITE_FIREBASE_AUTH_DOMAIN');
        firebaseConfig.projectId = window.netlify.env.get('VITE_FIREBASE_PROJECT_ID');
        // ... and so on for other keys
    } else {
        console.warn("Firebase config is not fully secure. Use Netlify environment variables for production.");
    }
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const $ = id => document.getElementById(id);
    const allScreens = document.querySelectorAll('.screen');
    const sidebar = $('sidebar');
    
    let state = {
        userId: null,
        currentSet: null, currentSetId: null,
        sourceLang: 'vi', targetLang: 'en',
        practiceType: 'word', gameMode: null,
        currentItems: [], currentItem: null,
        score: 0, lives: 3,
        canInteract: true, tempAiSet: null,
    };
    
    let sfx = {};
    const availableLangs = { 'vi': 'Ti·∫øng Vi·ªát üáªüá≥', 'en': 'Ti·∫øng Anh üá¨üáß', 'ko': 'Ti·∫øng H√†n üá∞üá∑' };
    
    function showScreen(screenId) {
        allScreens.forEach(s => s.classList.add('hidden'));
        $(screenId)?.classList.remove('hidden');
        sidebar.classList.toggle('game-active', ['game-screen', 'end-screen'].includes(screenId));
        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            $('menu-toggle').textContent = '‚ò∞';
        }
    }
    function showLoading(text) { $('loading-text').textContent = text; $('loading-modal').classList.remove('hidden'); }
    function hideLoading() { $('loading-modal').classList.add('hidden'); }
    function updateHUD() {
        $('score-display').textContent = `üíØ ƒêi·ªÉm: ${state.score}`;
        $('lives-display').innerHTML = '‚ù§Ô∏è'.repeat(Math.max(0, state.lives));
    }

    async function main() {
        showScreen('start-screen');
        try {
            await signInAnonymously(auth);
            state.userId = auth.currentUser.uid;
            setupFirestoreListener();
        } catch(e) {
            console.error("Auth Error:", e);
            alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh Firebase.");
        }
    }

    function setupFirestoreListener() {
        const userDocRef = doc(db, "users", state.userId);
        onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                renderSavedSets(docSnap.data().savedSets || {});
            } else {
                const initialUserSets = {};
                Object.keys(initialSets).forEach(key => {
                    initialUserSets[`default_${key}`] = { name: initialSets[key].name, items: initialSets[key].words, wrongItems: {} };
                });
                setDoc(userDocRef, { savedSets: initialUserSets });
            }
        });
    }

    function renderSavedSets(sets) {
        const list = $('saved-sets-list');
        list.innerHTML = '';
        Object.keys(sets).forEach(setId => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${sets[setId].name}</span><div style="display:flex; gap: 0.5rem;">
                <button class="btn small ok" data-set-id="${setId}">H·ªçc</button>
                ${setId.startsWith('default_') ? '' : `<button class="btn small danger" data-delete-id="${setId}">X√≥a</button>`}
            </div>`;
            list.appendChild(li);
        });
    }
    
    async function setupSfx() {
        if (Tone.context.state !== 'running') await Tone.start();
        sfx = {
            correct: new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination(),
            incorrect: new Tone.Synth({ oscillator: { type: 'square' } }).toDestination(),
        };
    }
    
    // --- EVENT LISTENERS & NAVIGATION ---
    $('start-btn').onclick = async () => { await setupSfx(); showScreen('set-selection-screen'); };

    $('ai-generate-btn').onclick = async () => {
        const topic = $('ai-topic-input').value.trim();
        if (topic.length < 2) return alert("Ch·ªß ƒë·ªÅ c·∫ßn √≠t nh·∫•t 2 k√Ω t·ª±.");
        
        showLoading("AI ƒëang s√°ng t·∫°o...");
        try {
            const response = await fetch('/.netlify/functions/generate-set', {
                method: 'POST',
                body: JSON.stringify({ topic, wordCount: $('word-count').value, sentenceCount: $('sentence-count').value })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ m√°y ch·ªß.");
            
            state.tempAiSet = { name: `AI: ${topic}`, items: data.items, wrongItems: {} };
            $('save-set-topic').textContent = topic;
            showScreen('save-set-modal');
        } catch (error) {
            alert(`L·ªói: ${error.message}`);
        } finally {
            hideLoading();
        }
    };
    
    $('confirm-save-btn').onclick = async () => {
        const newSetId = `ai_${Date.now()}`;
        await updateDoc(doc(db, "users", state.userId), { [`savedSets.${newSetId}`]: state.tempAiSet });
        handleSetSelection(newSetId, state.tempAiSet);
    };

    $('cancel-save-btn').onclick = () => handleSetSelection(`temp_${Date.now()}`, state.tempAiSet);

    $('saved-sets-list').onclick = async (e) => {
        const { setId, deleteId } = e.target.dataset;
        if (setId) {
            const docSnap = await getDoc(doc(db, "users", state.userId));
            handleSetSelection(setId, docSnap.data().savedSets[setId]);
        } else if (deleteId && confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªô t·ª´ n√†y?`)) {
            await updateDoc(doc(db, "users", state.userId), { [`savedSets.${deleteId}`]: deleteField() });
        }
    };

    function handleSetSelection(setId, set) {
        state.currentSetId = setId; state.currentSet = set;
        const sourceSelect = $('source-lang-select'), targetSelect = $('target-lang-select');
        sourceSelect.innerHTML = Object.entries(availableLangs).map(([c, n]) => `<option value="${c}">${n}</option>`).join('');
        targetSelect.innerHTML = sourceSelect.innerHTML;
        sourceSelect.value = 'vi'; targetSelect.value = 'en';
        showScreen('lang-selection-screen');
    }
    
    $('confirm-lang-btn').onclick = () => {
        state.sourceLang = $('source-lang-select').value;
        state.targetLang = $('target-lang-select').value;
        if (state.sourceLang === state.targetLang) return alert("Ng√¥n ng·ªØ h·ªçc v√† ƒë√≠ch ph·∫£i kh√°c nhau!");
        $('practice-type-screen').querySelector('[data-type="sentence"]').style.display = state.currentSet.items.some(i => i.type === 'sentence') ? 'block' : 'none';
        $('practice-set-title').textContent = `Ch·ªß ƒë·ªÅ: ${state.currentSet.name}`;
        showScreen('practice-type-screen');
    };

    $('practice-type-screen').onclick = (e) => {
        if (e.target.dataset.type) {
            state.practiceType = e.target.dataset.type;
            setupGameOptions();
            showScreen('game-setup-screen');
        }
    };

    function setupGameOptions() {
        const wrongItems = state.currentSet.wrongItems || {};
        const reviewItems = Object.values(wrongItems).filter(item => item.type === state.practiceType);
        $('review-count').textContent = `(${reviewItems.length})`;
        $('start-review-game-btn').disabled = reviewItems.length === 0;

        const allItemsCount = state.currentSet.items.filter(i => i.type === state.practiceType).length;
        const slider = $('question-count');
        slider.max = allItemsCount > 0 ? allItemsCount : 10;
        slider.value = Math.min(slider.value, slider.max);
        $('question-count-label').textContent = slider.value;
    }
    
    $('start-normal-game-btn').onclick = () => populateGameModes(false);
    $('start-review-game-btn').onclick = () => populateGameModes(true);
    
    function populateGameModes(isReviewMode) {
        $('menu-title').textContent = isReviewMode ? "√în t·∫≠p t·ª´ sai" : `Luy·ªán t·∫≠p ${state.practiceType === 'word' ? 'T·ª´ V·ª±ng' : 'M·∫´u C√¢u'}`;
        const modes = [
            { id: 'quiz-image', name: 'Xem h√¨nh ‚Üí ch·ªçn nghƒ©a', types: ['word'] },
            { id: 'listen-image', name: 'Nghe ‚Üí ch·ªçn h√¨nh', types: ['word'] },
            { id: 'fill-letter', name: 'ƒêi·ªÅn ch·ªØ c√°i', types: ['word'] },
            { id: 'fill-word', name: 'ƒêi·ªÅn t·ª´ v√†o c√¢u', types: ['sentence'] },
        ];
        const grid = $('game-modes-grid');
        grid.innerHTML = '';
        modes.filter(m => m.types.includes(state.practiceType)).forEach(mode => {
            const btn = document.createElement('button');
            btn.className = 'btn ok'; btn.textContent = mode.name;
            btn.onclick = () => startGame(mode.id, isReviewMode);
            grid.appendChild(btn);
        });
        showScreen('menu-screen');
    }
    
    $('nav-learn-btn').onclick = () => showScreen('set-selection-screen');
    $('nav-translate-btn').onclick = () => showScreen('translate-screen');
    $('lang-select-back-btn').onclick = () => showScreen('set-selection-screen');
    $('practice-type-back-btn').onclick = () => showScreen('lang-selection-screen');
    $('game-setup-back-btn').onclick = () => showScreen('practice-type-screen');
    $('menu-back-btn').onclick = () => showScreen('game-setup-screen');
    $('home-btn').onclick = () => showScreen('set-selection-screen');
    $('menu-toggle').onclick = () => {
        sidebar.classList.toggle('open');
        $('menu-toggle').textContent = sidebar.classList.contains('open') ? '‚úï' : '‚ò∞';
    };

    function setupTranslateScreen() {
        const source = $('translate-source-lang');
        const target = $('translate-target-lang');
        source.innerHTML = Object.entries(availableLangs).map(([c, n]) => `<option value="${c}">${n}</option>`).join('');
        target.innerHTML = source.innerHTML;
        source.value = 'vi';
        target.value = 'en';
    }
    setupTranslateScreen();

    $('translate-btn').onclick = async () => {
        const text = $('translate-input').value.trim();
        if(!text) return;
        const sourceLang = $('translate-source-lang').value;
        const targetLang = $('translate-target-lang').value;
        const output = $('translate-output');
        output.textContent = 'ƒêang d·ªãch...';

        try {
            const res = await fetch('/.netlify/functions/translate-text', {
                method: 'POST',
                body: JSON.stringify({ text, sourceLang, targetLang })
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.error);
            output.textContent = data.translatedText;
        } catch (e) {
            output.textContent = `L·ªói: ${e.message}`;
        }
    };
    
    function startGame(modeId, isReviewMode) {
        state.gameMode = modeId; state.score = 0; state.lives = 3;
        const sourceItems = isReviewMode 
            ? Object.values(state.currentSet.wrongItems || {}).filter(i => i.type === state.practiceType)
            : state.currentSet.items.filter(i => i.type === state.practiceType);
        
        if (sourceItems.length === 0) return alert("Kh√¥ng c√≥ t·ª´ n√†o ƒë·ªÉ h·ªçc!");
        
        state.currentItems = sourceItems.sort(() => 0.5 - Math.random()).slice(0, $('question-count').value);
        updateHUD(); showScreen('game-screen'); nextTurn();
    }

    async function nextTurn() {
        if (state.lives <= 0 || state.currentItems.length === 0) return endGame();
        state.canInteract = true; state.currentItem = state.currentItems.pop();
        const gameScreen = $('game-screen');
        gameScreen.innerHTML = `<div id="game-content">
            <div id="question-panel" class="game-panel question-panel"></div>
            <div id="answer-panel" class="game-panel answer-panel"></div>
        </div>`;
        
        switch(state.gameMode) {
            case 'quiz-image': await renderQuizImage(); break;
            case 'listen-image': await renderListenImage(); break;
            case 'fill-letter': await renderFillLetter(); break;
            case 'fill-word': await renderFillWord(); break;
        }
    }
    
    async function getDisplayImage(item) {
        showLoading("AI ƒëang v·∫Ω...");
        try {
            const res = await fetch('/.netlify/functions/get-image', { method: 'POST', body: JSON.stringify({ item }) });
            if (!res.ok) throw new Error("Image fetch failed");
            return (await res.json()).imageUrl;
        } catch(e) {
            return `https://placehold.co/600x400/eef5ff/6b7b93?text=${encodeURIComponent(item.en)}`;
        } finally {
            hideLoading();
        }
    }
    
    function speak(text, lang) {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = { 'vi': 'vi-VN', 'en': 'en-US', 'ko': 'ko-KR' }[lang];
        speechSynthesis.speak(u);
    }

    async function checkAnswer(isCorrect, element) {
        if (!state.canInteract) return;
        state.canInteract = false;
        const itemKey = (state.currentItem.vi || "").replace(/[.#$[\]]/g, '_');
        
        if (isCorrect) {
            sfx.correct?.triggerAttackRelease("C5", "8n");
            state.score += 10;
            element.style.background = 'var(--ok)';
            if (state.currentSetId && (state.currentSetId.startsWith('default_') || state.currentSetId.startsWith('ai_'))) {
                 await updateDoc(doc(db, "users", state.userId), { [`savedSets.${state.currentSetId}.wrongItems.${itemKey}`]: deleteField() });
            }
        } else {
            sfx.incorrect?.triggerAttackRelease("C3", "8n");
            state.lives -= 1;
            element.style.background = 'var(--danger)';
            if (state.currentSetId && (state.currentSetId.startsWith('default_') || state.currentSetId.startsWith('ai_'))) {
                 await updateDoc(doc(db, "users", state.userId), { [`savedSets.${state.currentSetId}.wrongItems.${itemKey}`]: state.currentItem });
            }
        }
        updateHUD();
        setTimeout(nextTurn, 1200);
    }
    
    function generateChoices(correctItem, numWrong, langKey) {
        const wrongItems = state.currentSet.items.filter(i => i.type === state.practiceType && i.vi !== correctItem.vi)
            .sort(() => 0.5 - Math.random()).slice(0, numWrong).map(i => i[langKey]);
        return [correctItem[langKey], ...wrongItems].sort(() => 0.5 - Math.random());
    }
    
    // --- RENDER GAME MODES ---
    async function renderQuizImage() {
        const qItem = state.currentItem;
        const qText = qItem[state.sourceLang];
        const aText = qItem[state.targetLang];
        const choices = generateChoices(qItem, 3, state.targetLang);
        
        const imageUrl = await getDisplayImage(qItem);
        $('question-panel').innerHTML = `<img src="${imageUrl}" alt="${qText}">`;
        
        const grid = document.createElement('div'); grid.className = 'choices-grid';
        choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'btn'; btn.textContent = choice;
            btn.onclick = (e) => checkAnswer(choice === aText, e.target);
            grid.appendChild(btn);
        });
        $('answer-panel').appendChild(grid);
    }
    
    async function renderListenImage() {
        const qItem = state.currentItem;
        const qText = qItem[state.sourceLang];
        const allChoiceItems = [qItem, ...state.currentSet.items.filter(i => i.type === 'word' && i.vi !== qItem.vi).sort(() => .5-Math.random()).slice(0,3)].sort(() => .5-Math.random());

        $('question-panel').innerHTML = `<button id="listen-again-btn">üîä</button>`;
        $('listen-again-btn').onclick = () => speak(qText, state.sourceLang);
        
        const imagePromises = allChoiceItems.map(item => getDisplayImage(item));
        const imageUrls = await Promise.all(imagePromises);
        
        const grid = document.createElement('div'); grid.className = 'choices-grid';
        allChoiceItems.forEach((choiceItem, i) => {
            const imgContainer = document.createElement('div');
            imgContainer.innerHTML = `<img src="${imageUrls[i]}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 12px; cursor: pointer;">`;
            imgContainer.onclick = (e) => checkAnswer(choiceItem.vi === qItem.vi, e.currentTarget);
            grid.appendChild(imgContainer);
        });
        $('answer-panel').appendChild(grid);
        speak(qText, state.sourceLang);
    }

    async function renderFillLetter() {
      const qItem = state.currentItem;
      const qText = qItem[state.sourceLang];
      const aText = qItem[state.targetLang].replace(/ /g, '');
      
      const imageUrl = await getDisplayImage(qItem);
      $('question-panel').innerHTML = `
          <img src="${imageUrl}" alt="${qText}">
          <button id="listen-again-btn">üîä</button>
          <p style="font-size: 1.2em; font-weight: bold;">${qText}</p>`;
      $('listen-again-btn').onclick = () => speak(qItem[state.targetLang], state.targetLang);
      
      const chars = [...aText];
      const missingCount = Math.max(1, Math.floor(chars.length * 0.5));
      const missingIndices = new Set([...Array(chars.length).keys()].sort(() => .5-Math.random()).slice(0, missingCount));
      
      const slots = document.createElement('div'); slots.id = 'word-slots';
      const lettersToFind = [];
      chars.forEach((char, i) => {
        const slot = document.createElement('div'); slot.className = 'slot';
        if (missingIndices.has(i)) { lettersToFind.push(char); } 
        else { slot.textContent = char; slot.classList.add('filled'); }
        slots.appendChild(slot);
      });
      
      const letterBank = document.createElement('div'); letterBank.id = 'letter-bank';
      const bankChars = [...new Set([...lettersToFind, ...'abcdefghijklmnopqrstuvwxyz'.split('').sort(() => .5-Math.random()).slice(0, 8-lettersToFind.length)])].sort(() => .5-Math.random());
      bankChars.forEach(char => {
        const tile = document.createElement('div'); tile.className = 'letter-tile';
        tile.textContent = char;
        tile.onclick = () => {
            const emptySlot = slots.querySelector('.slot:not(.filled)');
            if(emptySlot) { emptySlot.textContent = char; emptySlot.classList.add('filled'); }
        };
        letterBank.appendChild(tile);
      });

      const submitBtn = document.createElement('button'); submitBtn.className = "btn ok"; submitBtn.textContent = "Ki·ªÉm tra";
      submitBtn.onclick = () => checkAnswer([...slots.children].map(s => s.textContent).join('').toLowerCase() === aText.toLowerCase(), submitBtn);
      
      $('answer-panel').append(slots, letterBank, submitBtn);
    }
    
    function renderFillWord() {
        const qItem = state.currentItem; // a sentence
        const sentence = qItem[state.sourceLang];
        const parts = sentence.split(/(\[.*?\])/);
        const blankWordText = parts.find(p=>p.startsWith('[')).slice(1,-1);
        
        const blankWordItem = state.currentSet.items.find(i => i[state.sourceLang] === blankWordText);
        if(!blankWordItem) return nextTurn(); // Failsafe

        const choices = generateChoices(blankWordItem, 3, state.targetLang);
        
        $('question-panel').innerHTML = `<h3 style="font-size: 1.5em; line-height: 1.5;">${parts.map(p => p.startsWith('[') ? '______' : p).join('')}</h3>`;
        
        const grid = document.createElement('div'); grid.className = 'choices-grid';
        choices.forEach(choice => {
            const btn = document.createElement('button'); btn.className = 'btn';
            btn.textContent = choice;
            btn.onclick = (e) => checkAnswer(choice === blankWordItem[state.targetLang], e.target);
            grid.appendChild(btn);
        });
        $('answer-panel').appendChild(grid);
    }
    
    function endGame() { $('final-score').textContent = state.score; showScreen('end-screen'); }
    
    // --- SLIDERS ---
    ['word-count', 'sentence-count', 'question-count'].forEach(id => {
        const slider = $(id);
        if (slider) slider.oninput = () => $(`${id}-label`).textContent = slider.value;
    });

    main();
</script>
</body>
</html>
