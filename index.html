<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>H·ªçc M√† Ch∆°i - Th·∫ø Gi·ªõi AI ƒêa Ng·ªØ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap');
  :root{
    --bg-sky:#a7e0ff; --bg-grass:#b4f8c8; --primary:#fbe7c6; --secondary:#ffd6a5;
    --danger:#ff8a80; --ok:#b9f6ca; --text:#3d2a1f; --panel:#ffffffee;
    --shadow-color: #00000020; --sidebar-bg: #fdfaf4;
  }
  *{box-sizing:border-box;margin:0;padding:0; font-family:'Quicksand', sans-serif;}
  body{
    background:linear-gradient(135deg, var(--bg-sky), var(--bg-grass));
    color:var(--text); min-height:100vh;
    display:flex; overflow: hidden;
  }

  /* --- B·ªê C·ª§C: Sidebar + Main Content --- */
  #sidebar{
    width: 280px; flex-shrink: 0;
    background: var(--sidebar-bg);
    padding: 1.5rem; display: flex; flex-direction: column;
    box-shadow: 4px 0 20px var(--shadow-color); z-index: 10;
    transition: transform 0.3s ease-in-out;
  }
  #main-content{ flex: 1; position: relative; }

  /* --- Sidebar components --- */
  .sidebar-header { text-align: center; margin-bottom: 2rem;}
  .sidebar-header h2 { font-size: 1.8rem; }
  .sidebar-hud { background: #ffffffaa; border-radius: 16px; padding: 1rem; margin-bottom: 1.5rem; }
  .hud-item { margin-bottom: 0.8rem; font-size: 1.2rem; font-weight: 700; }
  #lives-display { font-size: 1.5rem; }
  .sidebar-controls { margin-top: auto; display: flex; flex-direction: column; gap: 0.5rem; }
  #voice-indicator { font-size:.9em; opacity:.8; text-align: center; margin-bottom: 1rem; font-style: italic; }
  .sidebar-hud, .sidebar-controls { display: none; }
  .game-active .sidebar-hud, .game-active .sidebar-controls { display: flex; }


  /* --- Qu·∫£n l√Ω c√°c m√†n h√¨nh (screen) --- */
  .screen{
    position:absolute; inset:0; padding:clamp(1rem, 5vh, 2rem);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    transition: opacity .35s ease-in-out, transform .35s ease-in-out;
    gap:clamp(0.8rem, 2vh, 1.5rem); text-align:center;
    overflow-y: auto;
  }
  .hidden{ opacity:0; transform:scale(.97); pointer-events:none; }
  
  /* --- Typography & Buttons --- */
  h1{font-size:clamp(32px, 4.5vmax, 52px); text-shadow:1px 1px 2px #fff9;}
  h2{font-size:clamp(24px, 3.5vmax, 40px);}
  p{font-size:clamp(16px, 1.8vmax, 22px);}
  .btn{
    width: 100%; padding:.8em 1.5em; border:none; border-radius:12px;
    background:var(--primary); font-weight:700; cursor:pointer;
    box-shadow: 0 4px var(--shadow-color);
    margin:.3em 0; transition: all .1s ease-out;
    font-size: clamp(16px, 1.6vmax, 20px);
  }
  .btn:hover{ transform:translateY(-2px); box-shadow:0 6px 12px var(--shadow-color); }
  .btn:active{ transform:translateY(1px); box-shadow:0 2px 4px var(--shadow-color); }
  .btn.secondary{background:var(--secondary);}
  .btn.ok{background:#b9f6ca;}
  .btn.small { padding: 0.6em 1em; font-size: clamp(14px, 1.4vmax, 16px); width: auto; }
  .btn[disabled]{opacity:.5; cursor:not-allowed; transform:none; box-shadow:none;}
  input, select {
    width:min(520px, 90%); padding:.8em; font-size:1.05em; text-align:center;
    border:3px solid var(--secondary); border-radius:14px; background:#fff; margin-bottom: 1rem;
    transition: border-color .3s;
  }
  select { text-align: left; padding: .6em; }

  /* --- M√†n h√¨nh ch·ªçn b·ªô th·∫ª & menu --- */
  .selection-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem; width: 100%; max-width: 1000px;
  }
  .menu-card {
    display:flex; align-items:center; gap:1rem; background:#fff;
    border-radius:16px; box-shadow:0 8px 20px #0001; padding:1rem; text-align:left;
  }
  .menu-card-icon { font-size:2em; }
  .menu-card-text { flex:1; } .menu-card-text b { font-size:1.1em; } .menu-card-text div { opacity:.8; }
  .menu-card .btn { width: auto; }
  
  .config-panel {
    display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; 
    justify-content: center; flex-wrap: wrap; background: #fff9;
    padding: 1rem; border-radius: 16px;
  }
  .config-item { display: flex; align-items: center; gap: 0.5rem;}

  /* === M√†n h√¨nh GAME === */
  #game-content{
    width:100%; height: 100%; display:flex; 
    align-items:center; justify-content:center;
    gap:2rem; padding:2rem;
  }
  
  /* --- Th·∫ª l·∫≠t & T·ªâ l·ªá ·∫£nh --- */
  #card-flipper {
    perspective: 1000px; cursor: pointer;
    width:min(45vh, 90vw, 450px); height:min(45vh, 90vw, 450px);
    flex-shrink:0;
  }
  .flipper-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
  #card-flipper.is-flipped .flipper-inner { transform: rotateY(180deg); }
  #animal-display, #card-back {
    position: absolute; width: 100%; height: 100%;
    -webkit-backface-visibility: hidden; backface-visibility: hidden;
    border-radius:20px; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
    background: #ffffffc0;
    box-shadow: 0 8px 25px var(--shadow-color);
  }
  #card-back {
    transform: rotateY(180deg);
    flex-direction: column; padding: 1.5rem; text-align: center;
  }
  #card-back h3 { margin-bottom: 0.2rem; font-size: 1.5em; color: var(--text); }
  #card-back h4 { margin-bottom: 0.5rem; font-size: 1.1em; opacity: 0.8; }
  #card-back p { font-size: 1em; }
  #animal-display img{ width:100%; height:100%; object-fit:contain; }
  
  /* --- Layout cho c√°c ch·∫ø ƒë·ªô ch∆°i --- */
  .game-panel {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 24px;
    padding: clamp(1rem, 2vw, 2rem);
    box-shadow: 0 8px 25px var(--shadow-color);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 1.5rem;
  }

  /* Ch·∫ø ƒë·ªô quiz-name & listen-image */
  #default-layout { flex: 1; height: 100%; width:100%; max-width: 800px; }
  .actions{ display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center; }
  #media-credit{ font-size:.9em; opacity:.85; }
  .choices-area, .img-grid {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:.8rem; width:100%; max-width:900px; margin-top:1vh;
  }
  .choice-btn { height: auto; min-height: 72px; padding: 0.8em 1em; font-size:1.1em; width: 100%; }
  .img-choice{
    border-radius:16px; overflow:hidden; background:#fff; border:4px solid transparent;
    box-shadow:0 8px 22px #0001; height:180px; cursor:pointer; transition: all .2s;
  }
  .img-choice:hover { transform:scale(1.03); box-shadow:0 12px 30px #0002; }
  .img-choice.correct{ border-color:var(--ok); } .img-choice.incorrect{ border-color:var(--danger); }
  .img-choice img{ width:100%; height:100%; object-fit:contain; }
  #listen-prompt { font-size: 5em; }

  /* --- CSS CHO ƒêI·ªÜN THO·∫†I --- */
  @media (max-width: 768px) {
    body { flex-direction: column; overflow: auto; }
    
    #sidebar {
      width: 100%;
      flex-direction: row; 
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 1rem;
      box-shadow: 0 4px 15px var(--shadow-color);
      flex-wrap: wrap;
    }
    .sidebar-header h2 { font-size: 1.5rem; }
    .sidebar-header p { display: none; }
    .sidebar-hud { display:flex; flex-direction: row; gap: 1rem; margin-bottom: 0; padding: 0; background: none; }
    .hud-item { margin-bottom: 0; font-size: 1rem; }
    #lives-display { font-size: 1.2rem; }
    .sidebar-controls { margin-top: 0; flex-direction: row; gap: 0.3rem; }
    .sidebar-controls .btn { padding: 0.5em; font-size: 0.9em; width: auto; }
    #voice-indicator { display: none; }

    .screen { padding: 1.5rem 1rem; }
    
    #game-content {
      flex-direction: column;
      padding: 1rem; gap: 1rem;
      height: auto;
    }
    #card-flipper {
      width: min(40vh, 60vw, 300px);
      height: min(40vh, 60vw, 300px);
    }
    .game-panel { padding: 1rem; }
    .choices-area, .img-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.5rem;
    }
    .choice-btn { min-height: 60px; font-size: 1em; }
  }

</style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">
        <h2>H·ªçc M√† Ch∆°i</h2>
        <p>Th·∫ø gi·ªõi AI</p>
    </div>
    <div class="sidebar-hud">
        <div class="hud-item" id="score-display">üíØ ƒêi·ªÉm: 0</div>
        <div class="hud-item" id="lives-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>
    <div id="voice-indicator">üé§ Gi·ªçng ƒë·ªçc Google</div>
    <div class="sidebar-controls">
        <button id="home-btn" class="btn">üè† V·ªÅ Menu</button>
        <button id="mute-btn" class="btn secondary">üîä T·∫Øt ti·∫øng</button>
    </div>
</div>

<main id="main-content">
  
  <!-- SET SELECTION -->
  <div id="set-selection-screen" class="screen">
      <h2>Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ ƒë·ªÉ h·ªçc</h2>
      <div id="set-selection-grid" class="selection-grid"></div>
  </div>

  <!-- MENU -->
  <div id="menu-screen" class="screen hidden">
    <h2 id="menu-title">Ch·ªß ƒë·ªÅ: ...</h2>
    
    <div class="config-panel">
        <div class="config-item">
            <select id="question-lang">
                <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                <option value="en">üá¨üáß Ti·∫øng Anh</option>
                <option value="ko">üá∞üá∑ Ti·∫øng H√†n</option>
            </select>
            <span style="font-size: 1.5em; font-weight: bold;">‚ñ∂Ô∏è</span>
            <select id="answer-lang">
                <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                <option value="en" selected>üá¨üáß Ti·∫øng Anh</option>
                <option value="ko">üá∞üá∑ Ti·∫øng H√†n</option>
            </select>
        </div>
        <div class="config-item">
            <label for="word-count">S·ªë l∆∞·ª£ng t·ª´:</label>
            <select id="word-count">
                <option value="10">10 t·ª´</option>
                <option value="20">20 t·ª´</option>
                <option value="all">T·∫•t c·∫£</option>
            </select>
        </div>
    </div>

    <div class="selection-grid">
      <div class="menu-card">
        <div class="menu-card-icon">üñºÔ∏è‚û°Ô∏èüî§</div>
        <div class="menu-card-text"><b>Xem h√¨nh ‚Üí ch·ªçn t√™n</b><div>Nh√¨n h√¨nh, ch·ªçn t√™n ƒë√∫ng.</div></div>
        <button id="mode-quiz-name" class="btn ok small">Ch∆°i</button>
      </div>
      <div class="menu-card">
        <div class="menu-card-icon">üîä‚û°Ô∏èüñºÔ∏è</div>
        <div class="menu-card-text"><b>Nghe ‚Üí ch·ªçn h√¨nh</b><div>Nghe t√™n r·ªìi ch·ªçn h√¨nh ƒë√∫ng.</div></div>
        <button id="mode-listen-image" class="btn ok small">Ch∆°i</button>
      </div>
       <div class="menu-card">
        <div class="menu-card-icon">üñºÔ∏è‚û°Ô∏è‚úçÔ∏è</div>
        <div class="menu-card-text"><b>Xem h√¨nh ‚Üí ƒëi·ªÅn ch·ªØ</b><div>Nh√¨n h√¨nh, ƒëi·ªÅn t√™n ƒë√∫ng.</div></div>
        <button id="mode-fill-word" class="btn ok small">Ch∆°i</button>
      </div>
    </div>
    <button id="menu-back-btn" class="btn">‚¨ÖÔ∏è ƒê·ªïi ch·ªß ƒë·ªÅ</button>
  </div>

  <!-- GAME -->
  <div id="game-screen" class="screen hidden">
    <div id="game-content">
      <div id="image-panel" class="game-panel">
          <div id="card-flipper">
              <div class="flipper-inner">
                  <div id="animal-display"></div>
                  <div id="card-back"></div>
              </div>
          </div>
          <div class="actions">
            <button id="listen-btn" class="btn small">üîä ƒê·ªçc</button>
            <button id="spell-btn" class="btn small">üî§ ƒê√°nh v·∫ßn</button>
            <button id="sound-btn" class="btn small" disabled>üêæ √Çm thanh</button>
          </div>
          <div id="media-credit"></div>
      </div>
            
      <div id="default-layout" class="game-panel">
          <div id="listen-prompt"></div>
           <div id="fill-in-panel" style="display: none; flex-direction: column; gap: 1rem; width:100%;">
            <input id="fill-in-input" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." />
            <button id="fill-in-check-btn" class="btn ok">Ki·ªÉm tra</button>
          </div>
          <div id="choices-area" class="choices-area"></div>
      </div>
    </div>
  </div>

  <!-- END -->
  <div id="end-screen" class="screen hidden">
    <h2>Ho√†n th√†nh!</h2>
    <p>ƒêi·ªÉm cu·ªëi c√πng c·ªßa b·∫°n:</p>
    <h1 id="final-score">0</h1>
    <button id="restart-btn" class="btn ok">Ch∆°i l·∫°i ch·ªß ƒë·ªÅ n√†y üîÑ</button>
    <button id="to-menu-btn" class="btn">üè† V·ªÅ Menu ch√≠nh</button>
  </div>

</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<script src="vocabulary.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const $ = id => document.getElementById(id);
    
    const screens = {
        setSelection: $('set-selection-screen'),
        menu: $('menu-screen'), 
        game: $('game-screen'), 
        end: $('end-screen'),
    };
    const sidebar = $('sidebar');
    
    let state = {
        score: 0, lives: 3, muted: false,
        chosenSetKey: null, mode: null, 
        questionLang: 'vi', answerLang: 'en',
        wordCount: 10,
        sessionWords: [],
        currentWordIndex: 0,
        curr: null, can: true, soundUnlocked: false
    };
    const mediaCache = JSON.parse(localStorage.getItem('mediaCache') || '{}');

    const sfx = {
        click: new Tone.PluckSynth({ volume: -10 }).toDestination(),
        ok: new Tone.PluckSynth({ volume: -8 }).toDestination(),
        nope: new Tone.MembraneSynth({ pitchDecay: .1, octaves: 2, volume: -10 }).toDestination()
    };
    function playSfx(key) { if(state.muted) return; (sfx[key])?.triggerAttackRelease(key === 'nope' ? 'C2' : 'C5', '8n'); }

    const tts = window.speechSynthesis;
    
    function show(screenId) {
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        screens[screenId].classList.remove('hidden');
        if (['game', 'end'].includes(screenId)) sidebar.classList.add('game-active');
        else sidebar.classList.remove('game-active');
    }

    function updateHUD() {
        $('score-display').textContent = `üíØ ƒêi·ªÉm: ${state.score}`;
        $('lives-display').innerHTML = '‚ù§Ô∏è'.repeat(state.lives);
    }

    function populateSetSelection() {
        const grid = $('set-selection-grid');
        grid.innerHTML = '';
        Object.keys(VOCABULARY_SETS).forEach(key => {
            const set = VOCABULARY_SETS[key];
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerHTML = set.name;
            btn.onclick = () => {
                state.chosenSetKey = key;
                $('menu-title').textContent = `Ch·ªß ƒë·ªÅ: ${set.name}`;
                show('menu');
            };
            grid.appendChild(btn);
        });
    }
    
    async function unlockAudio() {
        if(state.soundUnlocked) return;
        try {
            await Tone.start();
            sfx.click.triggerAttackRelease('C5', '16n');
            // A silent utterance is needed to unlock speech synthesis on some browsers
            const u = new SpeechSynthesisUtterance(''); u.volume = 0; tts.speak(u);
            state.soundUnlocked = true;
        } catch(e) { console.error("Audio unlock failed", e); }
    }
    
    async function start(mode) {
        state.mode = mode; 
        state.score = 0; 
        state.lives = 3; 
        updateHUD();
        
        // Prepare word list for the session
        const fullWordList = [...VOCABULARY_SETS[state.chosenSetKey].words];
        // Fisher-Yates Shuffle
        for (let i = fullWordList.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [fullWordList[i], fullWordList[j]] = [fullWordList[j], fullWordList[i]];
        }

        const count = state.wordCount === 'all' ? fullWordList.length : parseInt(state.wordCount, 10);
        state.sessionWords = fullWordList.slice(0, count);
        state.currentWordIndex = 0;

        await unlockAudio();
        show('game');
        next();
    }
    
    function end() {
        $('final-score').textContent = state.score;
        show('end');
    }
    
    async function next() {
        if (state.lives <= 0 || state.currentWordIndex >= state.sessionWords.length) {
            return end();
        }
        state.can = true;
        
        const wordObj = state.sessionWords[state.currentWordIndex];
        state.currentWordIndex++;
        
        const name = wordObj[state.questionLang];
        const answer = wordObj[state.answerLang];
        
        const media = await getMedia(name, wordObj.en);
        
        state.curr = { ...wordObj, name, answer, media };

        const cardFlipper = $('card-flipper');
        const display = $('animal-display');
        const cardBack = $('card-back');
        const choicesArea = $('choices-area');
        const imagePanel = $('image-panel');
        const listenPrompt = $('listen-prompt');
        
        cardFlipper.classList.remove('is-flipped');
        
        display.innerHTML = '';
        const img = new Image(); img.src = media.image; img.alt = name; img.referrerPolicy = 'no-referrer';
        img.onerror = () => { display.innerHTML = '<p>üò¢ L·ªói ·∫£nh</p>'; };
        display.appendChild(img);
        
        cardBack.innerHTML = `<h3>${wordObj.vi}</h3><h4>${wordObj.en} | ${wordObj.ko}</h4>`;

        $('media-credit').innerHTML = media.credit ? `<a href="${media.credit}" target="_blank" rel="noopener">Ngu·ªìn ·∫£nh: Wikipedia</a>` : '';
        $('sound-btn').disabled = !wordObj.sound;
        
        choicesArea.innerHTML = '';
        
        const fillInInput = $('fill-in-input');
        fillInInput.classList.remove('correct', 'incorrect');
        fillInInput.style.borderColor = 'var(--secondary)';

        $('choices-area').style.display = 'none';
        $('fill-in-panel').style.display = 'none';
        listenPrompt.style.display = 'none';
        imagePanel.style.display = 'flex';

        if (state.mode === 'quiz-name') {
            $('choices-area').style.display = 'grid';
            choicesArea.className = 'choices-area';
            // Use the full set for generating wrong answers to have more variety
            const fullSet = VOCABULARY_SETS[state.chosenSetKey].words;
            const wrong = fullSet.filter(w => w[state.answerLang] !== answer).sort(()=>0.5-Math.random()).slice(0, 3).map(w => w[state.answerLang]);
            [answer, ...wrong].sort(()=>0.5-Math.random()).forEach(n => {
                const b=document.createElement('button'); b.className='btn choice-btn'; b.textContent=n;
                b.onclick=()=>check(n,b); choicesArea.appendChild(b);
            });
        } else if (state.mode === 'listen-image') {
            imagePanel.style.display = 'none';
            listenPrompt.style.display = 'block';
            listenPrompt.textContent = 'üîä';
            $('choices-area').style.display = 'grid';
            choicesArea.className = 'img-grid';
            const fullSet = VOCABULARY_SETS[state.chosenSetKey].words;
            const wrongItems = fullSet.filter(w => w.vi !== wordObj.vi).sort(()=>0.5-Math.random()).slice(0, 3);
            const allItems = [wordObj, ...wrongItems].sort(()=>0.5-Math.random());
            const itemsMedia = await Promise.all(allItems.map(async item => ({ item, media: await getMedia(item[state.questionLang], item.en) })));
            itemsMedia.forEach(({ item, media }) => {
                const card=document.createElement('div'); card.className='img-choice';
                const im=new Image(); im.src = media.image; im.alt = item[state.questionLang]; im.referrerPolicy='no-referrer';
                card.appendChild(im); card.onclick=()=>check(item[state.answerLang], card); choicesArea.appendChild(card);
            });
        } else if (state.mode === 'fill-word') {
            $('fill-in-panel').style.display = 'flex';
            fillInInput.value = '';
            setTimeout(() => fillInInput.focus(), 100);
        }
        
        speak(name, state.questionLang);
    }
    
    function check(picked, node) {
        if(!state.can) return; state.can=false;

        const isCorrect = picked.toLowerCase() === state.curr.answer.toLowerCase();
        
        if (isCorrect) {
            playSfx('ok'); state.score += 10;
            node?.classList.add('correct');
            if(state.mode === 'fill-word') node.style.borderColor = 'var(--ok)';
        } else {
            playSfx('nope'); state.score = Math.max(0, state.score - 5); state.lives--;
            node?.classList.add('incorrect');
            if(state.mode === 'fill-word') node.style.borderColor = 'var(--danger)';
            // Show correct answer
            if (state.mode === 'quiz-name') {
                const buttons = Array.from($('choices-area').children);
                const correctButton = buttons.find(b => b.textContent.toLowerCase() === state.curr.answer.toLowerCase());
                correctButton?.classList.add('correct');
            }
        }

        updateHUD();
        setTimeout(next, 1500);
    }
    
    async function getMedia(name, englishName) {
      const cacheKey = englishName || name;
      if (mediaCache[cacheKey]) return mediaCache[cacheKey];
      const searchTerm = englishName || name;
      const sURL = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(searchTerm)}`;
      let image = null, credit = null;
      try {
          const res = await fetch(sURL);
          const data = await res.json();
          if (data.thumbnail?.source) image = data.thumbnail.source;
          if (data.content_urls?.desktop?.page) credit = data.content_urls.desktop.page;
      } catch (e) { console.error("Failed to fetch media", e); }
      const result = { image: image || `https://placehold.co/600x600/eef5ff/6b7b93?text=${encodeURIComponent(name)}`, credit };
      mediaCache[cacheKey] = result;
      localStorage.setItem('mediaCache', JSON.stringify(mediaCache));
      return result;
    }

    function speak(text, lang = 'vi') {
        if (state.muted || !text) return;
        
        // Use Google Translate TTS
        try {
            const langCodeMap = { 'vi': 'vi', 'en': 'en-US', 'ko': 'ko' };
            const langCode = langCodeMap[lang] || 'vi';
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=${langCode}&client=tw-ob`;
            const audio = new Audio(url);
            audio.play().catch(e => console.error("Audio playback failed:", e));
        } catch (e) {
            console.warn("Google TTS failed:", e);
        }
    }

    function spell(text, lang = 'vi') { 
      if (!text) return;
      const separator = lang === 'en' ? ' ' : ', ';
      speak(Array.from(text.replace(/\s+/g, ' ').trim()).join(separator), lang); 
    }
    
    // --- Bindings ---
    $('question-lang').onchange = (e) => state.questionLang = e.target.value;
    $('answer-lang').onchange = (e) => state.answerLang = e.target.value;
    $('word-count').onchange = (e) => state.wordCount = e.target.value;

    $('menu-back-btn').onclick = () => show('setSelection');
    
    ['mode-quiz-name', 'mode-listen-image', 'mode-fill-word'].forEach(id => {
        $(id).onclick = () => start(id.replace('mode-', ''));
    });
    
    $('fill-in-check-btn').onclick = () => {
        const userAnswer = $('fill-in-input').value.trim();
        if(userAnswer) check(userAnswer, $('fill-in-input'));
    };
    $('fill-in-input').onkeyup = (e) => {
        if (e.key === 'Enter') $('fill-in-check-btn').click();
    };

    $('restart-btn').onclick = () => start(state.mode);
    $('to-menu-btn').onclick = () => { populateSetSelection(); show('setSelection'); };
    $('home-btn').onclick = () => {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t? Ti·∫øn tr√¨nh s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.")) {
            show('menu');
        }
    };
    
    $('listen-btn').onclick = () => state.curr && speak(state.curr.name, state.questionLang);
    $('spell-btn').onclick = () => state.curr && spell(state.curr.answer, state.answerLang);
    $('sound-btn').onclick = () => state.curr?.sound && speak(state.curr.sound, 'vi');
    $('card-flipper').onclick = () => $('card-flipper').classList.toggle('is-flipped');

    $('mute-btn').onclick = () => {
        state.muted = !state.muted;
        $('mute-btn').textContent = state.muted ? 'üîá B·∫≠t ti·∫øng' : 'üîä T·∫Øt ti·∫øng';
        if(state.muted) tts.cancel();
    };

    // --- Init ---
    populateSetSelection();
    show('setSelection');
});
</script>
</body>
</html>
