<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>H·ªçc M√† Ch∆°i - Th·∫ø Gi·ªõi AI ƒêa Ng·ªØ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap');
  :root{
    --bg-sky:#a7e0ff; --bg-grass:#b4f8c8; --primary:#fbe7c6; --secondary:#ffd6a5;
    --danger:#ff8a80; --ok:#b9f6ca; --text:#3d2a1f; --panel:#ffffffee;
    --shadow-color: #00000020; --sidebar-bg: #fdfaf4;
  }
  *{box-sizing:border-box;margin:0;padding:0; font-family:'Quicksand', sans-serif;}
  body{
    background:linear-gradient(135deg, var(--bg-sky), var(--bg-grass));
    color:var(--text); min-height:100vh;
    display:flex; overflow: hidden;
  }

  /* --- B·ªê C·ª§C: Sidebar + Main Content --- */
  #sidebar{
    width: 280px; flex-shrink: 0;
    background: var(--sidebar-bg);
    padding: 1.5rem; display: flex; flex-direction: column;
    box-shadow: 4px 0 20px var(--shadow-color); z-index: 10;
    transition: transform 0.3s ease-in-out;
  }
  #main-content{ flex: 1; position: relative; }

  /* --- Sidebar components --- */
  .sidebar-header { text-align: center; margin-bottom: 2rem;}
  .sidebar-header h2 { font-size: 1.8rem; }
  .sidebar-hud { background: #ffffffaa; border-radius: 16px; padding: 1rem; margin-bottom: 1.5rem; }
  .hud-item { margin-bottom: 0.8rem; font-size: 1.2rem; font-weight: 700; }
  #lives-display { font-size: 1.5rem; }
  .sidebar-controls { margin-top: auto; display: flex; flex-direction: column; gap: 0.5rem; }
  #voice-indicator { font-size:.9em; opacity:.8; text-align: center; margin-bottom: 1rem; font-style: italic; }
  .sidebar-hud, .sidebar-controls { display: none; }
  .game-active .sidebar-hud, .game-active .sidebar-controls { display: block; }


  /* --- Qu·∫£n l√Ω c√°c m√†n h√¨nh (screen) --- */
  .screen{
    position:absolute; inset:0; padding:clamp(1rem, 5vh, 2rem);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    transition: opacity .35s ease-in-out, transform .35s ease-in-out;
    gap:clamp(0.8rem, 2vh, 1.5rem); text-align:center;
    overflow-y: auto;
  }
  .hidden{ opacity:0; transform:scale(.97); pointer-events:none; }
  
  /* --- Typography & Buttons --- */
  h1{font-size:clamp(32px, 4.5vmax, 52px); text-shadow:1px 1px 2px #fff9;}
  h2{font-size:clamp(24px, 3.5vmax, 40px);}
  p{font-size:clamp(16px, 1.8vmax, 22px);}
  .btn{
    width: 100%; padding:.8em 1.5em; border:none; border-radius:12px;
    background:var(--primary); font-weight:700; cursor:pointer;
    box-shadow: 0 4px var(--shadow-color);
    margin:.3em 0; transition: all .1s ease-out;
    font-size: clamp(16px, 1.6vmax, 20px);
  }
  .btn:hover{ transform:translateY(-2px); box-shadow:0 6px 12px var(--shadow-color); }
  .btn:active{ transform:translateY(1px); box-shadow:0 2px 4px var(--shadow-color); }
  .btn.secondary{background:var(--secondary);}
  .btn.ok{background:#b9f6ca;}
  .btn.small { padding: 0.6em 1em; font-size: clamp(14px, 1.4vmax, 16px); width: auto; }
  .btn[disabled]{opacity:.5; cursor:not-allowed; transform:none; box-shadow:none;}
  input, select {
    width:min(520px, 90%); padding:.8em; font-size:1.05em; text-align:center;
    border:3px solid var(--secondary); border-radius:14px; background:#fff; margin-bottom: 1rem;
    transition: border-color .3s;
  }
  select { text-align: left; padding: .6em; }

  /* --- M√†n h√¨nh ch·ªçn b·ªô th·∫ª & menu --- */
  .selection-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem; width: 100%; max-width: 1000px;
  }
  .menu-card {
    display:flex; align-items:center; gap:1rem; background:#fff;
    border-radius:16px; box-shadow:0 8px 20px #0001; padding:1rem; text-align:left;
  }
  .menu-card-icon { font-size:2em; }
  .menu-card-text { flex:1; } .menu-card-text b { font-size:1.1em; } .menu-card-text div { opacity:.8; }
  .menu-card .btn { width: auto; }
  
  /* --- AI Topic Generator --- */
  .ai-generator {
    background: #fff; padding: 1.5rem; border-radius: 16px; margin-top: 2rem;
    box-shadow: 0 8px 25px var(--shadow-color); width: 100%; max-width: 600px;
  }
  .ai-generator input { width: 100%; }
  .ai-generator .btn { margin-top: 0.5rem; }
  #loading-spinner {
    display: none; width: 40px; height: 40px; border: 5px solid #f3f3f3;
    border-top: 5px solid var(--secondary); border-radius: 50%;
    animation: spin 1s linear infinite; margin: 1rem auto;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* === M√†n h√¨nh GAME === */
  #game-content{
    width:100%; height: 100%; display:flex; 
    align-items:center; justify-content:center;
    gap:2rem; padding:2rem;
  }
  
  /* --- Th·∫ª l·∫≠t & T·ªâ l·ªá ·∫£nh --- */
  #card-flipper {
    perspective: 1000px; cursor: pointer;
    width:min(45vh, 90vw, 450px); height:min(45vh, 90vw, 450px);
    flex-shrink:0;
  }
  .flipper-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
  #card-flipper.is-flipped .flipper-inner { transform: rotateY(180deg); }
  #animal-display, #card-back {
    position: absolute; width: 100%; height: 100%;
    -webkit-backface-visibility: hidden; backface-visibility: hidden;
    border-radius:20px; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
    background: #ffffffc0;
    box-shadow: 0 8px 25px var(--shadow-color);
  }
  #card-back {
    transform: rotateY(180deg);
    flex-direction: column; padding: 1.5rem; text-align: center;
  }
  #card-back h3 { margin-bottom: 0.2rem; font-size: 1.5em; color: var(--text); }
  #card-back h4 { margin-bottom: 0.5rem; font-size: 1.1em; opacity: 0.8; }
  #card-back p { font-size: 1em; }
  #animal-display img{ width:100%; height:100%; object-fit:contain; }
  #card-back .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--secondary); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
  @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* --- Layout cho c√°c ch·∫ø ƒë·ªô ch∆°i --- */
  .game-panel {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 24px;
    padding: clamp(1rem, 2vw, 2rem);
    box-shadow: 0 8px 25px var(--shadow-color);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 1.5rem;
  }

  /* Ch·∫ø ƒë·ªô quiz-name & listen-image */
  #default-layout { flex: 1; height: 100%; width:100%; max-width: 800px; }
  .actions{ display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center; }
  #media-credit{ font-size:.9em; opacity:.85; }
  .choices-area, .img-grid {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:.8rem; width:100%; max-width:900px; margin-top:1vh;
  }
  .choice-btn { height: auto; min-height: 72px; padding: 0.8em 1em; font-size:1.1em; width: 100%; }
  .img-choice{
    border-radius:16px; overflow:hidden; background:#fff; border:4px solid transparent;
    box-shadow:0 8px 22px #0001; height:180px; cursor:pointer; transition: all .2s;
  }
  .img-choice:hover { transform:scale(1.03); box-shadow:0 12px 30px #0002; }
  .img-choice.correct{ border-color:var(--ok); } .img-choice.incorrect{ border-color:var(--danger); }
  .img-choice img{ width:100%; height:100%; object-fit:contain; }
  #listen-prompt { font-size: 5em; }

  /* --- Modals (B·∫£ng x·∫øp h·∫°ng, C√†i ƒë·∫∑t) --- */
  .modal-overlay{ background:#00000088; z-index: 100; }
  .modal-box{ background:#fff; padding:1.5rem; border-radius:16px; width:min(420px, 90%); animation: pop-in .3s ease-out; }
  @keyframes pop-in { from { transform:scale(0.9); opacity:0; } to { transform:scale(1); opacity:1; } }
  #leaderboard-list { padding-left: 1.5rem; } #leaderboard-list li { margin-bottom: 0.5rem; font-size:1.1em; }
  .settings-row { display:flex; flex-direction:column; gap:10px; }
  .settings-row label { display:flex; justify-content:space-between; align-items:center; }
  .settings-row input[type=range] { flex:1; margin-left:1rem; }
  
  /* --- CSS CHO ƒêI·ªÜN THO·∫†I --- */
  @media (max-width: 768px) {
    body { flex-direction: column; overflow: auto; }
    
    #sidebar {
      width: 100%;
      flex-direction: row; /* D√†n c√°c m·ª•c tr√™n sidebar theo h√†ng ngang */
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 1rem;
      box-shadow: 0 4px 15px var(--shadow-color);
      flex-wrap: wrap; /* Cho ph√©p xu·ªëng d√≤ng n·∫øu kh√¥ng ƒë·ªß ch·ªó */
    }
    .sidebar-header h2 { font-size: 1.5rem; }
    .sidebar-header p { display: none; } /* ·∫®n m√¥ t·∫£ cho g·ªçn */
    .sidebar-hud { display:flex; flex-direction: row; gap: 1rem; margin-bottom: 0; padding: 0; background: none; }
    .hud-item { margin-bottom: 0; font-size: 1rem; }
    #lives-display { font-size: 1.2rem; }
    .sidebar-controls { display:flex; margin-top: 0; flex-direction: row; gap: 0.3rem; }
    .sidebar-controls .btn { padding: 0.5em; font-size: 0.9em; width: auto; }
    #home-btn, #leaderboard-btn { display:none; } /* ·∫®n b·ªõt n√∫t cho g·ªçn */
    #voice-indicator { display: none; }

    .screen { padding: 1.5rem 1rem; }
    
    #game-content {
      flex-direction: column; /* Chuy·ªÉn layout game th√†nh c·ªôt d·ªçc */
      padding: 1rem; gap: 1rem;
      height: auto;
    }
    #card-flipper {
      width: min(40vh, 60vw, 300px);
      height: min(40vh, 60vw, 300px);
    }
    .game-panel { padding: 1rem; }
    .choices-area, .img-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.5rem;
    }
    .choice-btn { min-height: 60px; font-size: 1em; }
  }

</style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">
        <h2>H·ªçc M√† Ch∆°i</h2>
        <p>Th·∫ø gi·ªõi AI</p>
    </div>
    <div class="sidebar-hud">
        <div class="hud-item" id="score-display">üíØ ƒêi·ªÉm: 0</div>
        <div class="hud-item" id="lives-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>
    <div id="voice-indicator">üé§ Gi·ªçng ƒë·ªçc m·∫∑c ƒë·ªãnh</div>
    <div class="sidebar-controls">
        <button id="home-btn" class="btn">üè† V·ªÅ Menu</button>
        <button id="settings-btn" class="btn secondary">‚öôÔ∏è C√†i ƒë·∫∑t</button>
        <button id="mute-btn" class="btn secondary">üîä T·∫Øt ti·∫øng</button>
        <button id="leaderboard-btn" class="btn secondary">üèÜ X·∫øp h·∫°ng</button>
    </div>
</div>

<main id="main-content">
  <!-- START -->
  <div id="start-screen" class="screen">
    <h1>Th·∫ø Gi·ªõi AI ƒêa Ng·ªØ</h1>
    <p>Nh·∫≠p t√™n c·ªßa b√© ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>
    <input id="player-name-input" maxlength="20" placeholder="T√™n c·ªßa b·∫°n ‚úèÔ∏è"/>
    <button id="start-btn" class="btn ok">B·∫Øt ƒë·∫ßu ‚ñ∂Ô∏è</button>
  </div>
  
  <!-- SET SELECTION -->
  <div id="set-selection-screen" class="screen hidden">
      <h2>Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ c√≥ s·∫µn...</h2>
      <div id="set-selection-grid" class="selection-grid"></div>
      
      <div class="ai-generator">
        <h2>...Ho·∫∑c ƒë·ªÉ AI t·∫°o ch·ªß ƒë·ªÅ m·ªõi! ‚ú®</h2>
        <p>Nh·∫≠p m·ªôt ch·ªß ƒë·ªÅ b·∫•t k·ª≥ (vd: v≈© tr·ª•, gia ƒë√¨nh, th·ªùi ti·∫øt...)</p>
        <input id="topic-input" placeholder="Ch·ªß ƒë·ªÅ b·∫°n mu·ªën h·ªçc üöÄ" />
        <button id="generate-set-btn" class="btn ok">T·∫°o b·ªô t·ª´ v·ª±ng</button>
        <div id="loading-spinner"></div>
      </div>

      <button id="set-back-btn" class="btn" style="margin-top: 1rem;">‚¨ÖÔ∏è Quay l·∫°i</button>
  </div>

  <!-- MENU -->
  <div id="menu-screen" class="screen hidden">
    <h2 id="menu-title">Ch·ªß ƒë·ªÅ: ...</h2>
    
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; justify-content: center; flex-wrap: wrap;">
        <select id="question-lang">
            <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
            <option value="en">üá¨üáß Ti·∫øng Anh</option>
            <option value="ko">üá∞üá∑ Ti·∫øng H√†n</option>
        </select>
        <span style="font-size: 1.5em; font-weight: bold;">‚ñ∂Ô∏è</span>
        <select id="answer-lang">
            <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
            <option value="en" selected>üá¨üáß Ti·∫øng Anh</option>
            <option value="ko">üá∞üá∑ Ti·∫øng H√†n</option>
        </select>
    </div>

    <div class="selection-grid">
      <div class="menu-card">
        <div class="menu-card-icon">üñºÔ∏è‚û°Ô∏èüî§</div>
        <div class="menu-card-text"><b>Xem h√¨nh ‚Üí ch·ªçn t√™n</b><div>Nh√¨n h√¨nh, ch·ªçn t√™n ƒë√∫ng.</div></div>
        <button id="mode-quiz-name" class="btn ok small">Ch∆°i</button>
      </div>
      <div class="menu-card">
        <div class="menu-card-icon">üîä‚û°Ô∏èüñºÔ∏è</div>
        <div class="menu-card-text"><b>Nghe ‚Üí ch·ªçn h√¨nh</b><div>Nghe t√™n r·ªìi ch·ªçn h√¨nh ƒë√∫ng.</div></div>
        <button id="mode-listen-image" class="btn ok small">Ch∆°i</button>
      </div>
       <div class="menu-card">
        <div class="menu-card-icon">üñºÔ∏è‚û°Ô∏è‚úçÔ∏è</div>
        <div class="menu-card-text"><b>Xem h√¨nh ‚Üí ƒëi·ªÅn ch·ªØ</b><div>Nh√¨n h√¨nh, ƒëi·ªÅn t√™n ƒë√∫ng.</div></div>
        <button id="mode-fill-word" class="btn ok small">Ch∆°i</button>
      </div>
    </div>
    <button id="menu-back-btn" class="btn">‚¨ÖÔ∏è ƒê·ªïi ch·ªß ƒë·ªÅ</button>
  </div>

  <!-- GAME -->
  <div id="game-screen" class="screen hidden">
    <div id="game-content">
      <div id="image-panel" class="game-panel">
          <div id="card-flipper">
              <div class="flipper-inner">
                  <div id="animal-display"></div>
                  <div id="card-back"></div>
              </div>
          </div>
          <div class="actions">
            <button id="listen-btn" class="btn small">üîä ƒê·ªçc</button>
            <button id="spell-btn" class="btn small">üî§ ƒê√°nh v·∫ßn</button>
            <button id="sound-btn" class="btn small" disabled>üêæ √Çm thanh</button>
          </div>
          <div id="media-credit"></div>
      </div>
            
      <div id="default-layout" class="game-panel">
          <div id="listen-prompt"></div>
           <div id="fill-in-panel" style="display: none; flex-direction: column; gap: 1rem; width:100%;">
            <input id="fill-in-input" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." />
            <button id="fill-in-check-btn" class="btn ok">Ki·ªÉm tra</button>
          </div>
          <div id="choices-area" class="choices-area"></div>
      </div>
    </div>
  </div>

  <!-- END -->
  <div id="end-screen" class="screen hidden">
    <h2>K·∫øt th√∫c!</h2>
    <p>ƒêi·ªÉm cu·ªëi c√πng c·ªßa b·∫°n:</p>
    <h1 id="final-score">0</h1>
    <button id="restart-btn" class="btn ok">Ch∆°i l·∫°i ch·ªß ƒë·ªÅ n√†y üîÑ</button>
    <button id="to-menu-btn" class="btn">üè† V·ªÅ Menu ch√≠nh</button>
  </div>

  <!-- MODALS -->
  <div id="leaderboard-modal" class="screen hidden modal-overlay">
    <div class="modal-box">
      <h2>üèÜ B·∫£ng X·∫øp H·∫°ng</h2>
      <ol id="leaderboard-list"></ol>
      <button id="close-leaderboard-btn" class="btn">ƒê√≥ng</button>
    </div>
  </div>
  <div id="settings-modal" class="screen hidden modal-overlay">
    <div class="modal-box">
      <h2>T√πy ch·ªânh</h2>
      <div class="settings-row">
        <label>Gi·ªçng ƒë·ªçc:
          <select id="voice-select"><option>ƒêang t·∫£i...</option></select>
        </label>
        <label>T·ªëc ƒë·ªô: <span id="rate-value">1.0</span>
          <input type="range" id="rate-slider" min="0.7" max="1.3" step="0.05" value="1.0"/>
        </label>
        <label>Pitch: <span id="pitch-value">1.0</span>
          <input type="range" id="pitch-slider" min="0.8" max="1.3" step="0.05" value="1.0"/>
        </label>
      </div>
      <div style="margin-top:1rem; text-align:center;">
        <button id="save-settings-btn" class="btn ok">L∆∞u & ƒë√≥ng</button>
      </div>
    </div>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<script src="vocabulary.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const $ = id => document.getElementById(id);
    
    const screens = {
        start: $('start-screen'), setSelection: $('set-selection-screen'),
        menu: $('menu-screen'), game: $('game-screen'), end: $('end-screen'),
        settings: $('settings-modal'), leaderboard: $('leaderboard-modal')
    };
    const sidebar = $('sidebar');
    
    let state = {
        player: '', score: 0, lives: 3, muted: false,
        chosenSetKey: null, mode: null, 
        questionLang: 'vi', answerLang: 'en',
        curr: null, can: true, soundUnlocked: false
    };
    let settings = { voiceURI: 'auto', rate: 1.0, pitch: 1.0 };
    let voices = [];
    const mediaCache = JSON.parse(localStorage.getItem('mediaCache') || '{}');
    const descriptionCache = JSON.parse(localStorage.getItem('descriptionCache') || '{}');

    const sfx = {
        click: new Tone.PluckSynth({ volume: -10 }).toDestination(),
        ok: new Tone.PluckSynth({ volume: -8 }).toDestination(),
        nope: new Tone.MembraneSynth({ pitchDecay: .1, octaves: 2, volume: -10 }).toDestination()
    };
    function playSfx(key) { if(state.muted) return; (sfx[key])?.triggerAttackRelease(key === 'nope' ? 'C2' : 'C5', '8n'); }

    const tts = window.speechSynthesis;
    
    function show(screenId) {
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        screens[screenId].classList.remove('hidden');
        if (['game', 'end'].includes(screenId)) sidebar.classList.add('game-active');
        else if (!['settings', 'leaderboard'].includes(screenId)) sidebar.classList.remove('game-active');
    }

    function updateHUD() {
        $('score-display').textContent = `üíØ ƒêi·ªÉm: ${state.score}`;
        $('lives-display').innerHTML = '‚ù§Ô∏è'.repeat(state.lives);
    }

    function populateSetSelection() {
        const grid = $('set-selection-grid');
        grid.innerHTML = '';
        Object.keys(VOCABULARY_SETS).forEach(key => {
            const set = VOCABULARY_SETS[key];
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerHTML = set.name;
            btn.onclick = () => {
                state.chosenSetKey = key;
                $('menu-title').textContent = `Ch·ªß ƒë·ªÅ: ${set.name}`;
                show('menu');
            };
            grid.appendChild(btn);
        });
    }
    
    async function unlockAudio() {
        if(state.soundUnlocked) return;
        try {
            await Tone.start(); await Tone.getContext().resume();
            sfx.click.triggerAttackRelease('C5', '16n');
            const u = new SpeechSynthesisUtterance(''); u.volume = 0; tts.speak(u);
            state.soundUnlocked = true;
        } catch(e) { console.error("Audio unlock failed", e); }
    }
    
    async function start(mode) {
        state.mode = mode; state.score = 0; state.lives = 3; updateHUD();
        await unlockAudio();
        show('game');
        next();
    }
    
    function end() {
        saveHS(state.player, state.score);
        $('final-score').textContent = state.score;
        show('end');
    }
    
    async function next() {
        if (state.lives <= 0) { return end(); }
        state.can = true;
        const currentSet = VOCABULARY_SETS[state.chosenSetKey];
        if (!currentSet || !currentSet.words || currentSet.words.length === 0) {
            alert('B·ªô t·ª´ v·ª±ng n√†y b·ªã l·ªói ho·∫∑c r·ªóng!');
            show('setSelection');
            return;
        }
        const wordObj = currentSet.words[Math.floor(Math.random() * currentSet.words.length)];
        
        const name = wordObj[state.questionLang];
        const answer = wordObj[state.answerLang];
        
        const media = await getMedia(name, wordObj.en);
        
        state.curr = { ...wordObj, name, answer, media, audioElem: null };

        const cardFlipper = $('card-flipper');
        const display = $('animal-display');
        const cardBack = $('card-back');
        const choicesArea = $('choices-area');
        const imagePanel = $('image-panel');
        const listenPrompt = $('listen-prompt');
        
        cardFlipper.classList.remove('is-flipped');
        
        display.innerHTML = '';
        const img = new Image(); img.src = media.image; img.alt = name; img.referrerPolicy = 'no-referrer';
        img.onerror = () => { display.innerHTML = '<p>üò¢ L·ªói ·∫£nh</p>'; };
        display.appendChild(img);
        
        const cachedDesc = descriptionCache[wordObj.vi];
        cardBack.innerHTML = `<h3>${wordObj.vi}</h3><h4>${wordObj.en} | ${wordObj.ko}</h4><p>${cachedDesc || 'Nh·∫•n ƒë·ªÉ xem th√¥ng tin...'}</p>`;

        $('media-credit').innerHTML = media.credit ? `<a href="${media.credit}" target="_blank" rel="noopener">Ngu·ªìn ·∫£nh: Wikipedia</a>` : '';
        $('sound-btn').disabled = !wordObj.sound;
        if(media.audio){ const a = new Audio(media.audio); a.preload='auto'; a.crossOrigin='anonymous'; state.curr.audioElem=a; }

        choicesArea.innerHTML = '';
        
        // Reset styles for fill-in input
        const fillInInput = $('fill-in-input');
        fillInInput.classList.remove('correct', 'incorrect');
        fillInInput.style.borderColor = 'var(--secondary)';


        // Hide/show panels based on mode
        $('choices-area').style.display = 'none';
        $('fill-in-panel').style.display = 'none';
        listenPrompt.style.display = 'none';
        imagePanel.style.display = 'flex'; // Default to show image

        if (state.mode === 'quiz-name') {
            $('choices-area').style.display = 'grid';
            choicesArea.className = 'choices-area';
            const wrong = currentSet.words.filter(w => w[state.answerLang] !== answer).sort(()=>0.5-Math.random()).slice(0, 3).map(w => w[state.answerLang]);
            [answer, ...wrong].sort(()=>0.5-Math.random()).forEach(n => {
                const b=document.createElement('button'); b.className='btn choice-btn'; b.textContent=n;
                b.onclick=()=>check(n,b); choicesArea.appendChild(b);
            });
        } else if (state.mode === 'listen-image') {
            imagePanel.style.display = 'none';
            listenPrompt.style.display = 'block';
            listenPrompt.textContent = 'üîä';
            $('choices-area').style.display = 'grid';
            choicesArea.className = 'img-grid';
            const wrongItems = currentSet.words.filter(w => w.vi !== wordObj.vi).sort(()=>0.5-Math.random()).slice(0, 3);
            const allItems = [wordObj, ...wrongItems].sort(()=>0.5-Math.random());
            const itemsMedia = await Promise.all(allItems.map(async item => ({ item, media: await getMedia(item[state.questionLang], item.en) })));
            itemsMedia.forEach(({ item, media }) => {
                const card=document.createElement('div'); card.className='img-choice';
                const im=new Image(); im.src = media.image; im.alt = item[state.questionLang]; im.referrerPolicy='no-referrer';
                card.appendChild(im); card.onclick=()=>check(item[state.answerLang], card); choicesArea.appendChild(card);
            });
        } else if (state.mode === 'fill-word') {
            $('fill-in-panel').style.display = 'flex';
            fillInInput.value = '';
            setTimeout(() => fillInInput.focus(), 100); // Auto-focus input
        }
        
        speak(name, state.questionLang);
    }
    
    function check(picked, node) {
        if(!state.can) return; state.can=false;

        const isCorrect = picked.toLowerCase() === state.curr.answer.toLowerCase();
        
        if (isCorrect) {
            playSfx('ok'); state.score += 10;
            node?.classList.add('correct');
            if(state.mode === 'fill-word') node.style.borderColor = 'var(--ok)';
        } else {
            playSfx('nope'); state.score = Math.max(0, state.score - 5); state.lives--;
            node?.classList.add('incorrect');
            if(state.mode === 'fill-word') node.style.borderColor = 'var(--danger)';
        }

        updateHUD();
        setTimeout(next, 1200);
    }
    
    async function getMedia(name, englishName) {
      const cacheKey = englishName || name;
      if (mediaCache[cacheKey]) return mediaCache[cacheKey];
      const searchTerm = englishName || name;
      const sURL = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(searchTerm)}`;
      let image = null, credit = null;
      try {
          const res = await fetch(sURL);
          const data = await res.json();
          if (data.thumbnail?.source) image = data.thumbnail.source;
          if (data.content_urls?.desktop?.page) credit = data.content_urls.desktop.page;
      } catch (e) { console.error("Failed to fetch media", e); }
      const result = { image: image || `https://placehold.co/600x600/eef5ff/6b7b93?text=${encodeURIComponent(name)}`, credit, audio: null };
      mediaCache[cacheKey] = result;
      localStorage.setItem('mediaCache', JSON.stringify(mediaCache));
      return result;
    }

    async function getCardDescription(vietnameseName) {
        if (descriptionCache[vietnameseName]) return descriptionCache[vietnameseName];
        
        const functionUrl = `/.netlify/functions/get-description`;
        $('card-back').querySelector('p').innerHTML = '<div class="loader"></div>';

        try {
            const response = await fetch(functionUrl, {
                method: 'POST',
                body: JSON.stringify({ name: vietnameseName })
            });
            if (!response.ok) throw new Error(`Function error: ${response.status}`);
            const result = await response.json();
            const text = result.description;
            if (text) {
                descriptionCache[vietnameseName] = text;
                localStorage.setItem('descriptionCache', JSON.stringify(descriptionCache));
                return text;
            }
        } catch (error) {
            console.error("Serverless function call failed:", error);
        }
        return "Oops! Ch∆∞a c√≥ th√¥ng tin.";
    }

    async function speak(text, lang = 'vi') {
        if (state.muted || !text) return;
        if (tts.speaking) tts.cancel();

        // Try to use AI TTS first
        try {
            const response = await fetch('/.netlify/functions/get-tts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, lang })
            });
            if (!response.ok) throw new Error('TTS API failed');
            const data = await response.json();
            if (data.audio) {
                const audio = new Audio(`data:audio/mpeg;base64,${data.audio}`);
                audio.play();
                $('voice-indicator').textContent = `üé§: Gi·ªçng ƒë·ªçc AI`;
                return; // Success, exit function
            }
        } catch (e) {
            console.warn("AI TTS failed, falling back to browser's voice.", e);
        }

        // Fallback to browser's built-in TTS
        const u = new SpeechSynthesisUtterance(text);
        const langCodeMap = { 'vi': 'vi-VN', 'en': 'en-US', 'ko': 'ko-KR' };
        const langCode = langCodeMap[lang] || 'vi-VN';
        
        u.lang = langCode;
        u.rate = settings.rate;
        u.pitch = settings.pitch;
        
        let v = voices.find(v => v.voiceURI === settings.voiceURI) || 
                voices.find(v => v.lang === langCode && v.name.includes('Google')) ||
                voices.find(v => v.lang === langCode);
        
        if (v) u.voice = v;
        $('voice-indicator').textContent = `üé§: ${v ? v.name : 'M·∫∑c ƒë·ªãnh'}`;
        tts.speak(u);
    }

    function spell(text, lang = 'vi') { 
      if (!text) return;
      const separator = lang === 'en' ? ' ' : ', ';
      speak(Array.from(text.replace(/\s+/g, ' ').trim()).join(separator), lang); 
    }
    
    function populateVoices() {
      voices = tts.getVoices();
      const select = $('voice-select');
      select.innerHTML = '<option value="auto">T·ª± ƒë·ªông ch·ªçn</option>' + 
          voices.filter(v => v.lang.startsWith('vi') || v.lang.startsWith('en') || v.lang.startsWith('ko'))
          .map(v => `<option value="${v.voiceURI}">${v.name} (${v.lang})</option>`).join('');
      select.value = settings.voiceURI;
    }
    
    function showLB() {
        const hs = JSON.parse(localStorage.getItem('highScores')||'[]');
        $('leaderboard-list').innerHTML = hs.length? hs.map((s,i)=>`<li>#${i+1} ${s.name} - ${s.score} ƒëi·ªÉm</li>`).join('') : '<li>Ch∆∞a c√≥ ai ch∆°i!</li>';
        show('leaderboard');
    }

    function saveHS(name, score) {
        if (!name) return;
        const hs = JSON.parse(localStorage.getItem('highScores')||'[]');
        hs.push({name, score});
        hs.sort((a,b) => b.score - a.score);
        localStorage.setItem('highScores', JSON.stringify(hs.slice(0, 10)));
    }

    // --- Bindings ---
    $('start-btn').onclick = async () => {
        const name = $('player-name-input').value.trim();
        if (name.length < 2) {
             $('player-name-input').style.borderColor = 'red';
             return;
        }
        $('player-name-input').style.borderColor = '';
        state.player = name;
        await unlockAudio();
        populateSetSelection();
        show('setSelection');
    };

    $('generate-set-btn').onclick = async () => {
        const topic = $('topic-input').value.trim();
        if (!topic) {
            alert("Vui l√≤ng nh·∫≠p m·ªôt ch·ªß ƒë·ªÅ!");
            return;
        }
        const btn = $('generate-set-btn');
        const spinner = $('loading-spinner');

        btn.disabled = true;
        spinner.style.display = 'block';

        try {
            const response = await fetch('/.netlify/functions/generate-set', {
                method: 'POST',
                body: JSON.stringify({ topic: topic })
            });
            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }
            const data = await response.json();
            const dynamicKey = `dynamic_${topic.replace(/\s+/g, '_')}`;
            VOCABULARY_SETS[dynamicKey] = { name: `AI: ${topic}`, words: data.words };
            state.chosenSetKey = dynamicKey;
            $('menu-title').textContent = `Ch·ªß ƒë·ªÅ: AI - ${topic}`;
            show('menu');

        } catch (error) {
            console.error("Failed to generate set:", error);
            alert("R·∫•t ti·∫øc, AI kh√¥ng th·ªÉ t·∫°o b·ªô t·ª´ v·ª±ng l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i sau!");
        } finally {
            btn.disabled = false;
            spinner.style.display = 'none';
        }
    };
    
    $('question-lang').onchange = (e) => state.questionLang = e.target.value;
    $('answer-lang').onchange = (e) => state.answerLang = e.target.value;

    $('set-back-btn').onclick = () => show('start');
    $('menu-back-btn').onclick = () => show('setSelection');
    
    ['mode-quiz-name', 'mode-listen-image', 'mode-fill-word'].forEach(id => {
        $(id).onclick = () => start(id.replace('mode-', ''));
    });
    
    $('fill-in-check-btn').onclick = () => {
        const userAnswer = $('fill-in-input').value.trim();
        if(userAnswer) check(userAnswer, $('fill-in-input'));
    };
    $('fill-in-input').onkeyup = (e) => {
        if (e.key === 'Enter') $('fill-in-check-btn').click();
    };

    $('restart-btn').onclick = () => start(state.mode);
    $('to-menu-btn').onclick = () => { populateSetSelection(); show('setSelection'); };
    $('home-btn').onclick = () => { if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t?")) show('menu'); };
    
    $('listen-btn').onclick = () => state.curr && speak(state.curr.name, state.questionLang);
    $('spell-btn').onclick = () => state.curr && spell(state.curr.answer, state.answerLang);
    $('sound-btn').onclick = () => {
      if(state.curr?.sound) speak(state.curr.sound, 'vi');
      else if (state.curr?.audioElem) state.curr.audioElem.play();
    };
    $('card-flipper').onclick = async () => {
        const flipper = $('card-flipper');
        const cardBack = $('card-back');
        if (!flipper.classList.contains('is-flipped')) {
            if (!descriptionCache[state.curr.vi]) {
                const description = await getCardDescription(state.curr.vi);
                cardBack.querySelector('p').textContent = description;
            }
        }
        flipper.classList.toggle('is-flipped');
    };

    $('settings-btn').onclick = () => show('settings');
    $('save-settings-btn').onclick = () => {
        settings.rate = parseFloat($('rate-slider').value);
        settings.pitch = parseFloat($('pitch-slider').value);
        settings.voiceURI = $('voice-select').value;
        localStorage.setItem('gameSettings', JSON.stringify(settings));
        
        const currentScreen = sidebar.classList.contains('game-active') ? (state.lives > 0 ? (state.mode ? 'game' : 'end') : 'end') : 'menu';
        show(currentScreen);
    };
    $('mute-btn').onclick = () => {
        state.muted = !state.muted;
        $('mute-btn').textContent = state.muted ? 'üîá B·∫≠t ti·∫øng' : 'üîä T·∫Øt ti·∫øng';
        if(state.muted) tts.cancel();
    };
    $('leaderboard-btn').onclick = showLB;
    $('close-leaderboard-btn').onclick = () => {
      const currentScreen = sidebar.classList.contains('game-active') ? (state.lives > 0 ? (state.mode ? 'game' : 'end') : 'end') : 'menu';
      show(currentScreen);
    };

    // --- Init ---
    const savedSettings = JSON.parse(localStorage.getItem('gameSettings'));
    if (savedSettings) settings = savedSettings;
    const rateSlider = $('rate-slider'), rateValue = $('rate-value');
    const pitchSlider = $('pitch-slider'), pitchValue = $('pitch-value');
    rateSlider.value = settings.rate; rateValue.textContent = settings.rate;
    pitchSlider.value = settings.pitch; pitchValue.textContent = settings.pitch;
    rateSlider.oninput = (e) => rateValue.textContent = e.target.value;
    pitchSlider.oninput = (e) => pitchValue.textContent = e.target.value;
    
    populateVoices();
    if(tts.onvoiceschanged !== undefined) tts.onvoiceschanged = populateVoices;
    
    show('start');
});
</script>
</body>
</html>
